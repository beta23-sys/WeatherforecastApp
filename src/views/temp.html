<script setup>
import { ref, onMounted } from 'vue';
import sunny from '@/assets/sunny.jpg';
import rainy from '@/assets/rainy.jpg';
import { fetchDailyForecast } from '@/api/weatherService.js';

//
// --- Reactive state ---
//
const searchQuery     = ref('');
const location        = ref('Melbourne');
const isLoading       = ref(false);
const error           = ref(null);

const currentWeather  = ref({
  temp:        0,
  condition:   '',
  high:        0,
  low:         0,
  humidity:    'N/A',
  windSpeed:   'N/A',
  pressure:    'N/A',
  visibility:  'N/A',
  uvIndex:     'N/A',
  precipitation:'N/A',
  cloudCover:  'N/A',
  dewPoint:    'N/A'
});

const weatherDetails  = ref({
  humidity:    'N/A',
  windSpeed:   'N/A',
  pressure:    'N/A',
  visibility:  'N/A',
  uvIndex:     'N/A',
  precipitation:'N/A',
  cloudCover:  'N/A',
  dewPoint:    'N/A'
});

const hourlyForecast  = ref([]);
const dailyForecast   = ref([]);

//
// --- Weather condition mapping ---
//
const getWeatherCondition = (weatherCode) => {
  const weatherCodes = {
    1000: 'Clear',
    1001: 'Cloudy',
    1100: 'Mostly Clear',
    1101: 'Partly Cloudy',
    1102: 'Mostly Cloudy',
    2000: 'Fog',
    2100: 'Light Fog',
    4000: 'Drizzle',
    4001: 'Rain',
    4200: 'Light Rain',
    4201: 'Heavy Rain',
    5000: 'Snow',
    5001: 'Flurries',
    5100: 'Light Snow',
    5101: 'Heavy Snow',
    6000: 'Freezing Drizzle',
    6001: 'Freezing Rain',
    6200: 'Light Freezing Rain',
    6201: 'Heavy Freezing Rain',
    7000: 'Ice Pellets',
    7101: 'Heavy Ice Pellets',
    7102: 'Light Ice Pellets',
    8000: 'Thunderstorm'
  };
  return weatherCodes[weatherCode] || 'Unknown';
};

const getWeatherIcon = (weatherCode) => {
  if (weatherCode === 1000 || weatherCode === 1100) return 'sun';
  if (weatherCode >= 1001 && weatherCode <= 1102) return 'cloud-sun';
  if (weatherCode >= 2000 && weatherCode <= 2100) return 'smog';
  if (weatherCode >= 4000 && weatherCode <= 4201) return 'cloud-rain';
  if (weatherCode >= 5000 && weatherCode <= 5101) return 'snowflake';
  if (weatherCode >= 6000 && weatherCode <= 6201) return 'icicles';
  if (weatherCode >= 7000 && weatherCode <= 7102) return 'cloud-hail';
  if (weatherCode === 8000) return 'bolt';
  return 'cloud';
};

const getSummarizedCondition = (weatherData) => {
  const values = weatherData.values || {};
  
  // Check for extreme conditions first
  if (values.rainIntensityMax > 10) return 'Heavy Rain';
  if (values.rainIntensityMax > 3) return 'Rain';
  if (values.rainIntensityMax > 0) return 'Light Rain';
  
  if (values.snowIntensityMax > 0) return 'Snow';
  if (values.freezingRainIntensityMax > 0) return 'Freezing Rain';
  
  // Check cloud cover
  const cloudCover = values.cloudCoverAvg || 0;
  if (cloudCover > 70) {
    // If it's very cloudy, check if it's foggy
    if (values.visibilityAvg < 1) return 'Fog';
    return 'Cloudy';
  }
  if (cloudCover > 30) return 'Partly Cloudy';
  
  // Check for clear conditions
  if (cloudCover <= 30) {
    // Daytime vs nighttime (simplified)
    const now = new Date();
    const sunrise = new Date(values.sunriseTime || now);
    const sunset = new Date(values.sunsetTime || now);
    
    if (now > sunrise && now < sunset) {
      return 'Sunny';
    } else {
      return 'Clear';
    }
  }
  
  // Fallback based on weather code if available
  if (values.weatherCodeMax) {
    return getWeatherCondition(values.weatherCodeMax);
  }
  
  // Default fallback
  return 'Fair';
};

//
// --- Helpers to parse & map API data ---
//
const parseWeatherData = (data) => {
  // Check if the expected data structure exists
  if (!data?.timelines?.daily) return [];
  
  return data.timelines.daily.map(item => {
    // Handle potential missing startTime
    const date = item.time ? new Date(item.time) : new Date();
    
    // Safely access values with fallbacks
    const values = item.values || {};
    
    return {
      startTime: item.time || '',
      date: date.toLocaleDateString('en-US', { 
        month: 'numeric', 
        day: 'numeric', 
        year: 'numeric' 
      }),
      dayName: date.toLocaleDateString('en-US', { weekday: 'long' }),
      high: Math.round(values.temperatureMax || 0),
      low: Math.round(values.temperatureMin || 0),
      weatherCode: values.weatherCode || 0,
      condition: getSummarizedCondition(item),
      icon: getWeatherIcon(values.weatherCode || 0),
      humidity: values.humidityAvg ? `${Math.round(values.humidityAvg)}%` : 'N/A',
      windSpeed: values.windSpeedAvg ? `${Math.round(values.windSpeedAvg)} km/h` : 'N/A',
      pressure: values.pressureSurfaceLevelAvg ? `${Math.round(values.pressureSurfaceLevelAvg)} hPa` : 'N/A',
      visibility: values.visibilityAvg ? `${Math.round(values.visibilityAvg)} km` : 'N/A',
      uvIndex: values.uvIndexAvg ? Math.round(values.uvIndexAvg) : '0',
      precipitation: values.precipitationProbabilityAvg ? `${Math.round(values.precipitationProbabilityAvg)}%` : 'N/A',
      cloudCover: values.cloudCoverAvg ? `${Math.round(values.cloudCoverAvg)}%` : 'N/A'
    };
  });
};

const updateWeatherFromService = (weatherData) => {
  if (!weatherData.length) return;
  const today = weatherData[0];
  console.log('Weather data:', today);
  // Current weather card
  currentWeather.value = {
    temp: today.high,
    condition: today.condition,
    high: today.high,
    low: today.low,
    humidity: today.humidity,
    windSpeed: today.windSpeed,
    pressure: today.pressure,
    visibility: today.visibility,
    uvIndex: today.uvIndex,
    precipitation: today.precipitation,
    cloudCover: today.cloudCover,
    dewPoint: 'N/A' // This would need to be calculated or provided by API
  };

  // Update weather details
  weatherDetails.value = {
    humidity: today.humidity,
    windSpeed: today.windSpeed,
    pressure: today.pressure,
    visibility: today.visibility,
    uvIndex: today.uvIndex,
    precipitation: today.precipitation,
    cloudCover: today.cloudCover,
    dewPoint: 'N/A'
  };

  // Generate hourly forecast from daily data (simulated)
  hourlyForecast.value = weatherData.slice(0, 6).map((d, i) => {
    if (i === 0) {
      return {
        time: 'Now',
        temp: d.high,
        icon: d.icon
      };
    }
    
    // Create simulated hourly times
    const hour = new Date();
    hour.setHours(hour.getHours() + (i * 4)); // Every 4 hours
    
    return {
      time: hour.toLocaleTimeString('en-US', { 
        hour: 'numeric', 
        hour12: true 
      }),
      temp: Math.round(d.high - (Math.random() * 5)), // Slight variation
      icon: d.icon
    };
  });

  // Daily forecast
  dailyForecast.value = weatherData.map(d => ({
    day: d.dayName,
    date: d.date,
    high: d.high,
    low: d.low,
    condition: d.condition,
    icon: d.icon,
    weatherCode: d.weatherCode
  }));
};

//
// --- Fetch & search handlers ---
//
const fetchWeatherData = async (loc) => {
  isLoading.value = true;
  error.value = null;
  
  try {
    const data = await fetchDailyForecast(loc);
    console.log('Fetched data:', data);
    const parsed = parseWeatherData(data);
    console.log('Parsed data:', parsed);
    updateWeatherFromService(parsed);
  } catch (err) {
    error.value = `Error fetching weather data: ${err.message}`;
    console.error(err);
  } finally {
    isLoading.value = false;
  }
};

const searchLocation = async () => {
  if (!searchQuery.value.trim()) return;
  location.value = searchQuery.value.trim();
  searchQuery.value = '';
  await fetchWeatherData(location.value);
};

const getBackgroundClass = () => {
  const cond = currentWeather.value.condition.toLowerCase();
  if (cond.includes('rain') || cond.includes('drizzle')) return 'bg-rainy';
  if (cond.includes('cloud') || cond.includes('fog')) return 'bg-cloudy';
  if (cond.includes('snow') || cond.includes('ice')) return 'bg-snowy';
  if (cond.includes('thunder')) return 'bg-stormy';
  return 'bg-sunny';
};

onMounted(() => {
  fetchWeatherData(location.value);
});
</script>

<template>
  <section>
    <!-- Error Message -->
    <div v-if="error" class="alert alert-danger mb-4" role="alert">
      {{ error }}
    </div>

    <!-- Search Bar -->
    <div class="search-container mb-4">
      <div class="input-group">
        <input 
          type="text" 
          class="form-control search-bar" 
          placeholder="Search location..." 
          v-model="searchQuery"
          @keyup.enter="searchLocation"
          :disabled="isLoading"
        />
        <button 
          class="btn btn-primary search-btn" 
          type="button" 
          @click="searchLocation"
          :disabled="isLoading || !searchQuery.trim()"
        >
          <i class="fas" :class="isLoading ? 'fa-spinner fa-spin' : 'fa-search'"></i>
        </button>
      </div>
    </div>

    <!-- Current Weather -->
    <div class="weather-card current-weather mb-4" :class="getBackgroundClass()">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2 class="location-title mb-0">{{ location }}</h2>
          <p class="last-updated">Last updated: {{ new Date().toLocaleTimeString() }}</p>
        </div>
        <div class="text-end">
          <h1 class="display-1 mb-0">{{ currentWeather.temp }}°</h1>
          <p class="mb-0">{{ currentWeather.condition }}</p>
        </div>
      </div>
      <hr class="my-3"/>
      <div class="d-flex justify-content-between flex-wrap">
        <div class="detail-item">
          <i class="fas fa-temperature-high detail-icon"></i>
          <p>H:{{ currentWeather.high }}° / L:{{ currentWeather.low }}°</p>
        </div>
        <div class="detail-item">
          <i class="fas fa-tachometer-alt detail-icon"></i>
          <p>Pressure {{ weatherDetails.pressure }}</p>
        </div>
        <div class="detail-item">
          <i class="fas fa-wind detail-icon"></i>
          <p>Wind {{ weatherDetails.windSpeed }}</p>
        </div>
        <div class="detail-item">
          <i class="fas fa-tint detail-icon"></i>
          <p>Humidity {{ weatherDetails.humidity }}</p>
        </div>
      </div>
    </div>

    <!-- Hourly Forecast -->
    <div class="weather-card hourly-forecast mb-4 p-3">
      <h5 class="mb-3">Hourly Forecast</h5>
      <div class="d-flex overflow-auto">
        <div 
          v-for="hour in hourlyForecast" 
          :key="hour.time" 
          class="text-center me-3 hourly-item"
        >
          <p class="mb-1 small">{{ hour.time }}</p>
          <i :class="`fas fa-${hour.icon} mb-2`" style="font-size: 1.2rem;"></i>
          <p class="mb-0 fw-bold">{{ hour.temp }}°</p>
        </div>
      </div>
    </div>

    <!-- Daily Forecast -->
    <div class="mb-4">
      <h5 class="mb-3">7-Day Forecast</h5>
      <div class="row">
        <div 
          v-for="day in dailyForecast" 
          :key="day.day" 
          class="col-12 col-sm-6 col-lg-4 mb-3"
        >
          <div class="weather-card text-center p-3 h-100">
            <p class="mb-1 fw-bold">{{ day.day }}</p>
            <p class="mb-2 small text-muted">{{ day.date }}</p>
            <i :class="`fas fa-${day.icon} forecast-icon mb-2`"></i>
            <p class="mb-1">
              <span class="temp-high">{{ day.high }}°</span> / 
              <span class="temp-low">{{ day.low }}°</span>
            </p>
            <p class="mb-0 small">{{ day.condition }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Additional Weather Details -->
    <div class="weather-card p-3">
      <h5 class="mb-3">Weather Details</h5>
      <div class="row">
        <div class="col-6 col-md-3 mb-3">
          <div class="text-center">
            <i class="fas fa-eye detail-icon mb-2"></i>
            <p class="mb-1 small">Visibility</p>
            <p class="mb-0 fw-bold">{{ weatherDetails.visibility }}</p>
          </div>
        </div>
        <div class="col-6 col-md-3 mb-3">
          <div class="text-center">
            <i class="fas fa-sun detail-icon mb-2"></i>
            <p class="mb-1 small">UV Index</p>
            <p class="mb-0 fw-bold">{{ weatherDetails.uvIndex }}</p>
          </div>
        </div>
        <div class="col-6 col-md-3 mb-3">
          <div class="text-center">
            <i class="fas fa-cloud-rain detail-icon mb-2"></i>
            <p class="mb-1 small">Precipitation</p>
            <p class="mb-0 fw-bold">{{ weatherDetails.precipitation }}</p>
          </div>
        </div>
        <div class="col-6 col-md-3 mb-3">
          <div class="text-center">
            <i class="fas fa-cloud detail-icon mb-2"></i>
            <p class="mb-1 small">Cloud Cover</p>
            <p class="mb-0 fw-bold">{{ weatherDetails.cloudCover }}</p>
          </div>
        </div>
      </div>
    </div>
  </section>
</template>

<style scoped>
.search-bar {
  border-radius: 25px 0 0 25px;
  padding: 10px 15px;
  border: none;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.search-btn {
  border-radius: 0 25px 25px 0;
  padding: 10px 20px;
}

.current-weather {
  border-radius: 15px;
  padding: 20px;
  color: white;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.weather-card {
  border-radius: 15px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease;
  background: white;
}

.weather-card:hover {
  transform: translateY(-5px);
}

.bg-sunny {
  background: linear-gradient(135deg, #f6d365, #fda085);
}

.bg-cloudy {
  background: linear-gradient(135deg, #5b86e5, #36d1dc);
}

.bg-rainy {
  background: linear-gradient(135deg, #3a7bd5, #1a2980);
}

.bg-snowy {
  background: linear-gradient(135deg, #e6f3ff, #b3d9ff);
  color: #333 !important;
}

.bg-stormy {
  background: linear-gradient(135deg, #2c3e50, #34495e);
}

.temp-high {
  color: #ff6b6b;
  font-weight: bold;
}

.temp-low {
  color: #4d96ff;
  font-weight: bold;
}

.hourly-forecast {
  background: white;
}

.hourly-item {
  min-width: 80px;
  text-align: center;
  padding: 10px;
  background-color: rgba(0, 123, 255, 0.1);
  border-radius: 10px;
  margin-right: 10px;
  flex-shrink: 0;
}

.forecast-icon {
  font-size: 2rem;
  color: #1a73e8;
}

.detail-item {
  text-align: center;
  padding: 10px;
  min-width: 80px;
}

.detail-icon {
  font-size: 1.5rem;
  margin-bottom: 5px;
  color: rgba(255, 255, 255, 0.8);
}

.weather-card .detail-icon {
  color: #1a73e8;
}

.location-title {
  font-size: 1.8rem;
  font-weight: 600;
}

.last-updated {
  font-size: 0.8rem;
  opacity: 0.8;
}

.alert {
  border-radius: 10px;
}

/* Make scrollbar less visible */
.hourly-forecast .d-flex::-webkit-scrollbar {
  height: 5px;
}

.hourly-forecast .d-flex::-webkit-scrollbar-track {
  background: transparent;
}

.hourly-forecast .d-flex::-webkit-scrollbar-thumb {
  background: rgba(0, 123, 255, 0.3);
  border-radius: 10px;
}

@media (max-width: 768px) {
  .detail-item {
    padding: 5px;
    min-width: 60px;
  }
  
  .detail-item p {
    font-size: 0.8rem;
  }
  
  .detail-icon {
    font-size: 1.2rem;
  }
}
</style>

<div class="mt-4">
        <p class="fw-bold">Hourly Forecast</p>
        <div class="hourly-forecast">
          <div 
            v-for="(hour, index) in hourlyForecast" 
            :key="index" 
            class="hourly-item"
          >
            <p class="mb-1">{{ hour.time }}</p>
            <i class="fas" :class="`fa-${hour.icon}`"></i>
            <p class="mb-0 mt-1">{{ hour.temp }}°C</p>
          </div>
        </div>
      </div>